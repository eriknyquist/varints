#include "unity.h"
#include "varints.h"

#include <stdint.h>
#include <string.h>


typedef struct
{
    uint64_t value;
    uint32_t size;
    uint8_t bytes[VARINTS_MAX_ENCODED_LEN];
} _unsigned_test_data_t;


static _unsigned_test_data_t _unsigned_test_data[] =
{
    {0x0u, 1u, {0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x1u, 1u, {0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x2u, 1u, {0x02u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x3u, 1u, {0x03u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x4u, 1u, {0x04u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x5u, 1u, {0x05u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x6u, 1u, {0x06u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x7u, 1u, {0x07u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x8u, 1u, {0x08u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x9u, 1u, {0x09u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0xau, 1u, {0x0au, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x7cu, 1u, {0x7cu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x7du, 1u, {0x7du, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x7eu, 1u, {0x7eu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x7fu, 1u, {0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x80u, 2u, {0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x81u, 2u, {0x81u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x82u, 2u, {0x82u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x83u, 2u, {0x83u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x84u, 2u, {0x84u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x3ffcu, 2u, {0xfcu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x3ffdu, 2u, {0xfdu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x3ffeu, 2u, {0xfeu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x3fffu, 2u, {0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x4000u, 3u, {0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x4001u, 3u, {0x81u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x4002u, 3u, {0x82u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x4003u, 3u, {0x83u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x4004u, 3u, {0x84u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x1ffffcu, 3u, {0xfcu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x1ffffdu, 3u, {0xfdu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x1ffffeu, 3u, {0xfeu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x1fffffu, 3u, {0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x200000u, 4u, {0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x200001u, 4u, {0x81u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x200002u, 4u, {0x82u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x200003u, 4u, {0x83u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x200004u, 4u, {0x84u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0xffffffcu, 4u, {0xfcu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0xffffffdu, 4u, {0xfdu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0xffffffeu, 4u, {0xfeu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0xfffffffu, 4u, {0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x10000000u, 5u, {0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x10000001u, 5u, {0x81u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x10000002u, 5u, {0x82u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x10000003u, 5u, {0x83u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x10000004u, 5u, {0x84u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x7fffffffcu, 5u, {0xfcu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x7fffffffdu, 5u, {0xfdu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x7fffffffeu, 5u, {0xfeu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x7ffffffffu, 5u, {0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x800000000u, 6u, {0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x800000001u, 6u, {0x81u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x800000002u, 6u, {0x82u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x800000003u, 6u, {0x83u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x800000004u, 6u, {0x84u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x3fffffffffcu, 6u, {0xfcu, 0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x3fffffffffdu, 6u, {0xfdu, 0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x3fffffffffeu, 6u, {0xfeu, 0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x3ffffffffffu, 6u, {0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u, 0x00u}},
    {0x40000000000u, 7u, {0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u}},
    {0x40000000001u, 7u, {0x81u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u}},
    {0x40000000002u, 7u, {0x82u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u}},
    {0x40000000003u, 7u, {0x83u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u}},
    {0x40000000004u, 7u, {0x84u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u, 0x00u}},
    {0x1fffffffffffcu, 7u, {0xfcu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u}},
    {0x1fffffffffffdu, 7u, {0xfdu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u}},
    {0x1fffffffffffeu, 7u, {0xfeu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u}},
    {0x1ffffffffffffu, 7u, {0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u, 0x00u}},
    {0x2000000000000u, 8u, {0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u}},
    {0x2000000000001u, 8u, {0x81u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u}},
    {0x2000000000002u, 8u, {0x82u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u}},
    {0x2000000000003u, 8u, {0x83u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u}},
    {0x2000000000004u, 8u, {0x84u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u, 0x00u}},
    {0xfffffffffffffcu, 8u, {0xfcu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u}},
    {0xfffffffffffffdu, 8u, {0xfdu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u}},
    {0xfffffffffffffeu, 8u, {0xfeu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u}},
    {0xffffffffffffffu, 8u, {0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u, 0x00u}},
    {0x100000000000000u, 9u, {0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u}},
    {0x100000000000001u, 9u, {0x81u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u}},
    {0x100000000000002u, 9u, {0x82u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u}},
    {0x100000000000003u, 9u, {0x83u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u}},
    {0x100000000000004u,  9u, {0x84u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u, 0x00u}},
    {0x7ffffffffffffffcu, 9u, {0xfcu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u}},
    {0x7ffffffffffffffdu, 9u, {0xfdu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u}},
    {0x7ffffffffffffffeu, 9u, {0xfeu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u}},
    {0x7fffffffffffffffu, 9u, {0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x7fu, 0x00u}},
    {0x8000000000000000u, 10u, {0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u}},
    {0x8000000000000001u, 10u, {0x81u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u}},
    {0x8000000000000002u, 10u, {0x82u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u}},
    {0x8000000000000003u, 10u, {0x83u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u}},
    {0x8000000000000004u, 10u, {0x84u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x80u, 0x01u}},
    {0xfffffffffffffffbu, 10u, {0xfbu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x01u}},
    {0xfffffffffffffffcu, 10u, {0xfcu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x01u}},
    {0xfffffffffffffffdu, 10u, {0xfdu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x01u}},
    {0xfffffffffffffffeu, 10u, {0xfeu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x01u}},
    {0xffffffffffffffffu, 10u, {0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0xffu, 0x01u}}
};

#define UNSIGNED_ENTRY_COUNT (sizeof(_unsigned_test_data) / sizeof(_unsigned_test_data[0]))

void setUp(void)
{
}

void tearDown(void)
{
}


// Tests that all values in the unsigned test table can be encoded into the expected bytes stream
void test_varint_u64_encode(void)
{
    for (int i = 0; i < UNSIGNED_ENTRY_COUNT; i++)
    {
        uint8_t buf[VARINTS_MAX_ENCODED_LEN];
        int size = 0;

        TEST_ASSERT_EQUAL_INT(0, varint_encode_u64(_unsigned_test_data[i].value, buf, &size));
        TEST_ASSERT_EQUAL_INT(_unsigned_test_data[i].size, size);
        TEST_ASSERT_EQUAL_INT(0, memcmp(_unsigned_test_data[i].bytes, buf, size));
    }
}


// Tests that all bytes streams in the unsigned test table can be decoded into the expected values
void test_varint_u64_decode(void)
{
    for (int i = 0; i < UNSIGNED_ENTRY_COUNT; i++)
    {
        uint64_t value;
        int size = 0;

        TEST_ASSERT_EQUAL_INT(0, varint_decode_u64(_unsigned_test_data[i].bytes, &value, &size));
        TEST_ASSERT_EQUAL_INT(_unsigned_test_data[i].size, size);
        TEST_ASSERT_TRUE(_unsigned_test_data[i].value == value);
    }
}


int main(void)
{
    UNITY_BEGIN();

    RUN_TEST(test_varint_u64_encode);
    RUN_TEST(test_varint_u64_decode);

    return UNITY_END();
}
